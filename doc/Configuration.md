# Integrators guide

<a name="logging"></a>
## Logging

### The configuration file

Logging in TARA is handled by [Log4j2 framework](https://logging.apache.org/log4j/2.x/index.html) which can be configured by using an [xml configuration file](https://logging.apache.org/log4j/2.x/manual/configuration.html) (`log4j2.xml`).

TARA provides a [default configuration](../src/main/webapp/WEB-INF/classes/log4j2.xml) that can be overridden by providing a custom configuration file.

You can override the default log configuration in the `application.properties` by using the property `logging.config` (see CAS documentation for further logging implementation [details](https://apereo.github.io/cas/5.1.x/installation/Logging.html).)

Example:
````
logging.config=file:/etc/cas/config/log4j2.xml
````

### Log files

By default, all log files are written to the local filesystem `/var/log/cas`. The location can be overridden either by providing a parameter `-Dcas.log.dir=<logdir>` during TARA startup or overriding the `log4j2.xml` file.

Log files are rolled over hourly or when the size cap for a file is reached or the TARA service has been restarted. Files that are rolled over are compressed with `gz` and transferred to directory that corresponds to a date pattern `yyyy-MM`).

List of log files created by TARA on initialization:

| **Type of log**        | **Contents description** |
| :---------------- | :---------- |
| **[cas.log](Configuration.md#cas_log)** | TARA's main log event stream that contains all authentication attempts and general system events (session expirations and cleanup events, etc).  |
| **[cas_error.log](Configuration.md#cas_error_log)** | Errors with technical and detailed stack traces. |
| **[cas_audit.log](Configuration.md#cas_audit_log)** | Pre-defined events derived from user actions to be audited for security purposes. |
| **stats.log** | Simplified CSV formatted authentication statistics. See [statistics specification](https://e-gov.github.io/TARA-Doku/Statistika) for log record specification and further details. |
| **perfStats.log** | Performance metrics. Periodically prints report that consists of brief memory, thread allocation and ticket stats. |


<a name="cas_log"></a>
### cas.log

Events are recorded in the json format, separated by the newline character `\n`.

Log event structure:

| **Field**       | **Description** | **Always present** |
| :---------------- | :---------- | :---------- |
| **date** | Event date and time in ISO-8601 compatible format. Example: `2018-08-17T18:23:48,543` | Y |
| **level** | Level of importance. Possible values (from the least serios to most serious): `TRACE`, `DEBUG`, `INFO`, `WARN`, `ERROR`, `FATAL` | Y |
| **requestId** | Unique 16 character alphanumeric string to identify the user's request. Empty when the event was generated by CAS itself. | N |
| **sessionId** | Session id hash. Base64 encoded session identifier (sha256 hash from of the session id). Empty when the event was generated by CAS itself. | N |
| **logger** | Logger name | Y |
| **thread** | Thread name | Y |
| **msg** | Log message using the JSON encoding format, this follows the escaping rules specified by RFC 4627 section 2.5. | Y |


Example:
````
{"date":"2018-08-19T17:11:25,373", "level":"ERROR", "requestId":"LPBA1Q0KKC8DNJSK", "sessionId":"xB4WXSgEJgFIUtGLjq0bTswIzgrWTsUX-ik6LrpKQ1w=", "logger":"ee.ria.sso.flow.action.AbstractAuthenticationAction", "thread":"http-nio-8081-exec-4", "msg":"Authentication failed: Sertifikaati ei leitud! Kas Teie ID-kaart on kaardilugejasse sisestatud?"}
````

<a name="cas_error_log"></a>
### cas_error.log

Events are recorded in the json format, separated by the newline character `\n`.

Log event structure:

| **Field**       | **Description** | **Always present** |
| :---------------- | :---------- | :---------- |
| **date** | Event date and time in ISO-8601 compatible format. Example: `2018-08-17T18:23:48,543` | Y |
| **level** | Level of importance. Either: `ERROR` or `FATAL` | Y |
| **requestId** | Unique 16 character alphanumeric string to identify the user's request. Empty when the event was generated by CAS itself. | N |
| **sessionId** | Session id hash. Base64 encoded session identifier (sha256 hash from of the session id). Empty when the event was generated by CAS itself.   | N |
| **logger** | Logger name | Y |
| **thread** | Thread name | Y |
| **throwable** | Exception trace using the JSON encoding format, this follows the escaping rules specified by RFC 4627 section 2.5. Empty when no trace was provided. | N |

Example:
````
{"date":"2018-08-19T17:11:25,373", "level":"ERROR", "requestId":"LPBA1Q0KKC8DNJSK", "sessionId":"xB4WXSgEJgFIUtGLjq0bTswIzgrWTsUX-ik6LrpKQ1w=", "throwable":" ee.ria.sso.authentication.TaraAuthenticationException: Sertifikaati ei leitud! Kas Teie ID-kaart on kaardilugejasse sisestatud?\u000A\u0009at ee.ria.sso.service.idcard.IDCardAuthenticationService.handleException(IDCardAuthenticationService.java:120)\u000A\u0009at ........ more\u000A"}
````



<a name="cas_audit_log"></a>
### cas_audit.log

Events are recorded in the json format, separated by the newline character `\n`.

Log event structure:

| **Field**       | **Description** |
| :---------------- | :---------- |
| **requestId** | Unique 16 character alphanumeric string to identify the user's request. Empty when the event was generated by CAS itself. |
| **sessionId** | Session id hash. Base64 encoded session identifier (sha256 hash from of the session id). Empty when the event was generated by CAS itself.   |
| **msg** | JSON object (escaped by the rules specified by RFC 4627 section 2.5). <br><br>List of fields contained in the JSON object (all mandatory): <br><br>* **action** - Audit event code, that describes the action in the audit trail. See TARA related events [here](Configuration.md#audit_events).<br>* **who** - User ID. Principal code if authenticated, otherwise `audit:unknown`<br>* **what** - Custom message related to the event<br>* **when** - Event date and time in ISO-8601 compatible format. Example: `2018-08-17T18:23:48,543`<br>* **clientIpAddress** - Client IP<br>* **serverIpAddress** - Server IP<br>* **application** - Server instance name from the application configuration parameter `cas.audit.appCode`. Defaults to `CAS`. |

Example of unescaped audit msg:
````
{
	"action": "AUTHENTICATION_EVENT_TRIGGERED",
	"who": "audit:unknown",
	"what": "[event=success,timestamp=Sun Aug 19 13:45:25 GMT 2018,source=RankedAuthenticationProviderWebflowEventResolver]",
	"when": "2018-08-19T17:11:25,373",
	"clientIpAddress": "172.10.0.1",
	"serverIpAddress": "172.10.0.2",
	"application": "TARA-INSTANCE-3"
}
````

Example - a failed ID-Card authentication:
````
{"requestId":"LPBA1Q0KKC8DNJSK", "sessionId":"xB4WXSgEJgFIUtGLjq0bTswIzgrWTsUX-ik6LrpKQ1w=", "msg":"{\"action\":\"ESTEID_AUTHENTICATION_FAILED\",\"who\":\"audit:unknown\",\"what\":\"Supplied parameters: map['service' -> 'https://koogelmoogel.net/oauth2.0/callbackAuthorize?client_name=CasOAuthClient&client_id=openIdDemo&redirect_uri=https://tara-client.arendus.kit:8451/oauth/response', 'execution' -> 'ef02319d-5a67-424a-869e-eb0d3524d10e_ZXlKaGJHY2lPaUpJVXpVeE1pSjkuSzBKVGQxbG9hRW94VnpWMWVXZFVVRFp5TW5wU1FsVnFORVo2VEV4bVNrRlZjbmg0YVZOWlpUZHBNMWd3ZDFkV2VVSnhVMnc0VURaWWVXOVdZakJRTjJWNWNuUmlZa3A0Vm1GeU0wOXRhVGRYYkVKaFZHYzVWMFV3ZFdsWGNsQkhNSHBFZDNkTVpHTllXbGxsUzJkWmVWWmhPVzQySzNkVk9DdDVNbk5GUTFKS01FZHVVM3A0ZWt4U1JXRkxiRm94VERCcVUzSlJVeXN3SzFWemFFUTFkME5EVlVGb2VFdHFkV2xQY0hOa00yNTFlRUY1Um05aFltZ3JUaXRPWkRkWWN6WkRhMFZGVVRCbGFVOUNOaTk2YmpaTlYydGxRWFZqTDFWcWJtaGlibVJESzNSSmNVRm9kVFpaWVhaUmFIQlpjblpRT1ZCbWVWRjRSSGhaVjBaVFRHVTJaVzkzYVVZNWRHdE9aR2RZY1hCMU1XTTBaM05wVVhaVlJuTnlhME01VTA5MWNWTlJXWE51U25aUmVYaGlhMHA0V0VGNmNuaDNWbWQyYjB0clRVSkxPR3BDYlVkVU9VSXZXWE5UYzFjeksya3JTMWhSWVc1NVptOHhlRVZMVWxaT1UyRkpPV280ZUVsVFkzcHBTRU16YzBoQk5DdHhWR3RXTmtWQ05GRlVVU3RIYTBoeUt6bDVNa3hVY0ZKdWFHSXZTMlZtTDNKWVdIVkVTVEl2ZFdVMU9FcFFRalpRZWxSQk5GaEpNa2RGYzFCTlpGaHdlbEZVYjB4WU5XMTBhRlkxYkdsU09FbFphM3BCY1d0WWFYWmplREJJUjFSWlZIZEZOMEpKTUdwQk1HNW9hbFJ1UjAxMFdrOTZlV0V3UzAxYVYycFpja05aTUhWWk9HOW1NV2x6Y210V0wySTNRWGREYlhCaFRXWjRWRWwyUTJvMFNHbDJXWGhJYlRseWJDdDBTbUZRVDNSVWFraHRNV0pPUjBob00xUmlPRloyYkRCdlpqSjBVRXgxYmtabVQxUnBiakUwYmpOWVQzSjRiV053V1ZsemRWbE1VMmsxT1doa1oyRnJhSHBGV21OUmQwVlZXSE5HUlRabWFURkdNRmhHVEU1c1NFVkxZVzFJUzJzdlMyOVJkVlpTYm5OT1VrRkdRak4zVjBaRlYzSkRLMEpIY1Vvd2FtRXpha1ZpWkc0ck9ETTNkemxRYjNwTFNVeFJNamMzY21sS1ducHlXbU5CV0VvMEwwTkxiMjg0UVdFeFVuRXpiRlk1VWs1cFQwUk5ZM2hVY1M5UFVGSXlVWEoyVERob1RuTnNhVWt6Vm1JMk5UaHpjVVZ1V1d4VVNrWjRVVWcyYm1sVlRsWTNNREJDVG5CRFNtMUdjaTk1Y1hSek1UbEtha1psZWxKeE5WWnhWbFJFZFhaTWFtSnBUMFFyV210UlUwWjJUMkpQWlV4dlQxbExjRVZ4YVZnNGRuRkdha2RSTlZoVmMzWnFjRWxEU2s0dlMyYzBNbUk1V2pJNGExbGlWWGxFV1ZCck5FZDJaRWg1UTJFelZFeFROMkk1U201d1JGaE5TbWcyVVZRcmNubHpjaXRQUlRSbVZIUTBOSFkxYldacU5HNWhRbUZOT0ZodVpIRm9aRXMwZFVRd09XTkxLMEprWm5OR1ZFbHJVazVsYlZkQldsbFdSMVJEUlNzMFZIZEZaVE5IWkZwUlFsZ3hVR3BtVkZwa01DODNOMDVxTm1aUWRtbHhZM01yYVVsbmRYbGlXRlpMZEZaVU1VOU5iVzlYTm5GNmJHTXpWWGhYVTJwdU5sY3ZRMFZQTWxsVFpGQlJZalJvUjFKTFdISXdkSEZ3SzNOQ2EyZERMMGcyYUhnMmFrZ3hSRVZKT0hOMU5sSkJjSE5rWmtKRGRFNVRUbEpvY2tONWNuVkNaa2hHYld0c1pUbElkRmRDTkhKUUszSkRiREp3YlZwd1Z6TnBlWE14VGtKcmNta3JjREpYVGtwa00yTk5Ta2RTYzFaSk5VdFFaMlJYUzJGa1RWcGhSMU1yUVc1YWQwdE1SQzk1T1hvNFZFcHJXRk5rUTJWcFpIRjZjMGR3VERrNU1XOVFPRUo1ZUhaSlZUZ3lNa1UwUzNWaU9Hb3lTR3R3ZWpCSE4xTkhVV1F2U2pKUFFVRTJOamxsU200dllVZE5aVmcwTW05emFtMUxTRVZoTmtjdmVFRnNORFZxVkhobmRXdGpTVlpwY3pFM2RFcFpNVGM0U20xVVJFZEpaRkp4YkdScmVXZEJSSFUyWmxaVWNITlVabFpLZUVGYVRsaElTbEJtUkdOQlpYVXlOakI0TUc5eVRISXZSRFo1Y2s5Uk5FTk1VRGxHZG5WNWJXOU9kbU5PVkRGc01Fd3hiRXhVYzBvclJsSnBMMlkyVXpaYVJUVk1NaTlaZGt0UGRXVkVNalZPYlVoTVlsaEtNalU0Wld0YVpqVldPR2RhTDB3ME5XRmljbXd6ZVZocU9UUlhkME00TmpGTlJrc3ZMMFpQV1dGdVQwOTVSRmhYV0hwek5uVXlPRUZSTm5CVWRuZE5VVGRPZVZsdWJXWjJTMVY2TVZOSFVsSlpabUowVHpSUEwxUkpSRTQ1UmtoaWVEZDFUemxUY1VjeVlYUkRabGt2VDBSU1JraElTMjgxYldkWmRYUlNTeTlOY21OWmJFRXhNako2ZWtvMlJUaEdVbGc1YVhGa1lrTndaM04wUVZGTFR6SnNhRFZpY1c1d1drcHFTRFJGUW5VMVMzVlBNRFozT0VwME5tNDFjMlZFYjJoWlEzZFBkWEpTUW5odFVUUlJiRE5LYXpkUVpVRjJWbWQ2UnpseFMyWmFjbGxPTTBkQlFuaFBURkl5VW1Gc2NHdzBiMnBNZFdwUVZGVXZPWHAxWTAxalQyazJWU3R6ZWxBeldVVXdZa05RYzFWT1UxUm1kRXN3ZFRWWU1HNWFUMUJvTkhVMVRTdHRiR1pEU0M5blN6UmlielV3VjJOdGNHaG5URkpHZFdwbFNUaExjaXRHVWxaYWNVZG9ibXM1VVZGWVV6ZFVibTFOUjNCaVJXNVVhRUZHY1VnNE5IZ3JTbHBvSzBsQ2MxbElTM051TTFka2RVUmhWbVJXVFdzd2FXTnZPV0lyYUZWT1ltUjJWRlJETkU1Q2NVZFVkbkZJVldGMlluZDBWUzlPZFhWVU4xWk5VRGhoVGpScmJsWlhZWGx1S3pKSlNuTktORWRqTTNKRk9VMWtLMm92VUZKaVpqaGxUa1Z3UzB4TFJsSkplWFZaVlhJeUswaEhjRU5QWVZSemJIUlFkM2g0Y2s1VFQzSlZSMHB3U1ZWcVpEZERTV3ROTldWNU9ERXZiRko0TkdGSk0wVlpVbXhoWWpKQmRuZFVaWGROSzFGNlUzZDRaelkyTm1walVIbEZUelpsZWpKQ2NGTlhhaTlLZW10Tk4zSnpkU3RRTWtSb05qVktRbVpMTnpSWFIzUXhSVmRqVlZwemJUVlJialpCUjB4VU9ETnVlRFJTYVRCek1VUkJNbVpGWXpaVFVIcFVSRFp0U21kdFdYTnllVWx4WVRaRWFWbDJUVkJ3TlZOUWIwdHBTVFV2UmtGMFdUQm9jR1ZIU25Sd1lUTnpLM05EYmtvdmNFOU1VRzV3V0VsNVltZGljVU5FUzB4a1dtWTNXbXRMTW5KcEx6Wk1iMUFyTkRab01YZzVVVlpRV0dWamN6aEtXbFkzWkZoSmJHSmpNWGhEYnpsMVUyVm1NbmhNT1ZVeVZGcG1WemwxWTBSQ1NuSjVNMUE1Y0ZkNmVHdG5WU3QzWmpnNE1EaDRSRlZvY0VOaVpsWXZNbFJvU0U1bk0xSnBlVzQ0ZVVOTWNuaFJlRlJFTVRWekwyUlVkR2RpTkdKcllYRkJLMUJWY2s1UFRraHRVVVo2TlVjck1FeHVkekpzTm1WcVFtTlZjMk5CVTJVeU5HVnpOVFJUZVdONlJrVkxVMnhJU2tVM2FrZEtkMWREVFZkTGFEaGhUak5QVEV0cldVWkpjVVI0YVU1MVl6RmxTVGR1YUc0MmJHOHZSVTFyV2pOcGFsQmFWa05WUzBoSE5XcDZhMVZEZFcwMFduRk5kSE14ZUV4dFJFSTRTM2c0V2xOR2NrNDVZV2tyWm10dGFXRXdNVEJEWldSNFlWSnVUR1V5VDFGcE5uUmlWM0ZVUm5GMlYyNHdNVlZyUWtVNFFsTm9NVGc1VmpNM1VtWjBkV3Q0Y0RCRmQxQTBhVUZOVGswclltbDRSekZRWm5BeU5XTm1Ta3d2Y2xOUFYzZG9hMEZMYnpsblIyOHJXRU5DVm1KT2IxVkJTWGQxU1ZkbVZuWTFMMGQzTWtob1pHcDBOVlpqWTFJemJuVmpUbUpOTkU5dmVYVlhUV001YUZkeldVbHFiREowVmpkVlVEQjFlbWRRVW1Ga1IyZFRaR3hFS3l0cGJXNVlMMGwzVEhCR0x5dGpkR2g0U1hJMFRtcHdMekIwVlVJMFNUWXpaMUExWTJSQ1ppOWpXVlUxZGpCSFNtWTFka05sZEZSd2VqaGFaMWt4WlRsMmVuYzVNM3B2ZDA1UldXa3ZjVXhJTTJkeVkxSkVjR050V2xob1lWRkhTakpTWVM4elMyUkxhR2w2ZDAxM1NIQklkMWRDVUVSbGRHTjVlRFJtT1cxQlZFWk5kMVJTYURsTmEwMWtSMjVLVTFNMU0yWkxNVlZxWWpGNE5HSnBPV2tyZEZVNFNXTlVaa1J6Ym13ek15dFNSVTlPY0ZKc1ExcFdWa1lyVlZOMmFXMU1SMWR6VG01M1UzQnhUVWxNYVdkaFNUSkhiek5pVld0Wk5IVXpNaTl6Vm1GblZqQk1PRTluYmpOeVNVSnJNRkZXYTJoeWJsbHdPVXBJVTBvMFVqbEpiVTVMS3psSFJEQmFUVzFpYzNOUmNpOUhUR2RCVmtVM0sxTkliMmRRVFd0clJHeFFSVVZJVGk5WVNWaFZaMVo0VFVvM1VuSjRlRWx1U25ST2MxcFBSMlpIZEdwV1JHWjNTWFZyYzJFeldtTktWVVJCVEVkSVJrNWlSMDlXTURsWFUzVTBWWE41YzBOdk5IZDFVMVYzT0RCeVVVTnJMMDR5U1VZMFUyMUNLMGN5ZUZjeVYwUnpTRVJNYVdzMVYyOVlkSFIyVlhWbWFXRlRPV2R4ZEZWc1dFa3hWSGg2YzBOSGJtZ3lTblY2UTBKamVrTnlLMWRwY0hsbWRYRnBkMEZXUzB4VU5VMTFVa1owYjJOYUwwaFZUM1pwV2pONmJEQTFjVTQ1YTBjMFJFUlVWMmhZVWt4VGJEWkpUR1V2WWxWVlNHOUtNMWRpVjJsaE4wa3ZSeTl2TURKTFR6bG1WSEYxYkc4MlFVcFRUMVpWVTA1YWMwWmxVbVp4Wm1GdEwzTnhiVFJOYkZablpIUmhlVFZqTURoYU9FaGFOR2RxYjFFM1JsUkliR3BWYTFSM2IyeHJTR3RWVlZVcmFuZEtTVEZWTkM5dlRYVXZORWQ2Vldkek5rNVliRmQ0ZUhoRVprOWpTRmcxTnpsNmNFZGlkazR4YVVKTmNFRkxjRWMxUlRKUU5HaDNVRTVXZUVrMWNVNUZWR3hZUVc1dlYyUmxOMjlWYjFseFQyMVFSVUZsVlVzM09URk1aamh5YlZCU1dWSjVZbEIwVVdsRWIxRmhhbXBZVURSM2VrSkNZMVEwV1hwMk9YWmlVRzlOTW1wck5reElUbTloTTIxWlJUVlpPV1ppUlZCM1ZVMDBTVE5sUkdNclJHTTNla1ZhY0V4UEt6WkxhMUJ5TnpSaFR6a3hTRmhqTkhKVE9ISTRRMFJ0VkhaeWQxTmpUalY0VVZOaVMwTTNPRWwzUzBkak5pOWxURGhJYlZkeFFtbEpaUS5qbWh5MlJoc0lBMXhjaXBnM1pvREZlT1RQSmJ1VTN3a2ZTN082enBWLUVpdi1Eelk5ZW90bkNCbl9hRVBNdUozMlZidklHakxuYzMzNGgwQVBVeTd3dw==', '_eventId' -> 'idsubmit', 'idlang' -> '', 'geolocation' -> '']\",\"when\":\"Sun Aug 19 17:11:25 GMT 2018\",\"clientIpAddress\":\"172.20.0.4\",\"serverIpAddress\":\"172.20.0.9\",\"application\":\"TARA-INSTANCE-3\"}"}
````

Example - full audit trail of successful ID-Card authentication:
````
{"requestId":"4SO0EG1Q44P0QS5K", "sessionId":"XjUIZZxMtqFQdcwgC8uLPBov8PuSJ5PUXcif1XWlA4k=", "msg":"{\"action\":\"AUTHENTICATION_EVENT_TRIGGERED\",\"who\":\"audit:unknown\",\"what\":\"[event=success,timestamp=Sat Aug 18 21:19:28 GMT 2018,source=RankedAuthenticationProviderWebflowEventResolver]\",\"application\":\"CAS1\",\"when\":\"Sat Aug 18 21:19:28 GMT 2018\",\"clientIpAddress\":\"172.20.0.4\",\"serverIpAddress\":\"172.20.0.9\"}"}
{"requestId":"CUA1DKFJ9U22IU27", "sessionId":"XjUIZZxMtqFQdcwgC8uLPBov8PuSJ5PUXcif1XWlA4k=", "msg":"{\"action\":\"ESTEID_AUTHENTICATION_SUCCESS\",\"who\":\"audit:unknown\",\"what\":\"Supplied parameters: map['service' -> 'https://koogelmoogel.net/oauth2.0/callbackAuthorize?client_name=CasOAuthClient&client_id=openIdDemo&redirect_uri=https://tara-client.arendus.kit:8451/oauth/response', 'execution' -> '...............', '_eventId' -> 'idsubmit', 'idlang' -> '', 'geolocation' -> '']\",\"application\":\"CAS1\",\"when\":\"Sat Aug 18 21:19:39 GMT 2018\",\"clientIpAddress\":\"172.20.0.4\",\"serverIpAddress\":\"172.20.0.9\"}"}
{"requestId":"CUA1DKFJ9U22IU27", "sessionId":"XjUIZZxMtqFQdcwgC8uLPBov8PuSJ5PUXcif1XWlA4k=", "msg":"{\"action\":\"AUTHENTICATION_SUCCESS\",\"who\":\"EE38207114725\",\"what\":\"Supplied credentials: [ee.ria.sso.authentication.credential.TaraCredential@9947efba]\",\"application\":\"CAS1\",\"when\":\"Sat Aug 18 21:19:39 GMT 2018\",\"clientIpAddress\":\"172.20.0.4\",\"serverIpAddress\":\"172.20.0.9\"}"}
{"requestId":"CUA1DKFJ9U22IU27", "sessionId":"XjUIZZxMtqFQdcwgC8uLPBov8PuSJ5PUXcif1XWlA4k=", "msg":"{\"action\":\"TICKET_GRANTING_TICKET_CREATED\",\"who\":\"EE38207114725\",\"what\":\"TGT-**********************************************wW0cpD04CK-koogelmoogel\",\"application\":\"CAS1\",\"when\":\"Sat Aug 18 21:19:39 GMT 2018\",\"clientIpAddress\":\"172.20.0.4\",\"serverIpAddress\":\"172.20.0.9\"}"}
{"requestId":"CUA1DKFJ9U22IU27", "sessionId":"XjUIZZxMtqFQdcwgC8uLPBov8PuSJ5PUXcif1XWlA4k=", "msg":"{\"action\":\"SERVICE_TICKET_CREATED\",\"who\":\"EE38207114725\",\"what\":\"ST-1-l1203Y5dlNWF9bTfsvPt-koogelmoogel for https://koogelmoogel.net/oauth2.0/callbackAuthorize?client_name=CasOAuthClient&client_id=openIdDemo&redirect_uri=https://tara-client.arendus.kit:8451/oauth/response\",\"application\":\"CAS1\",\"when\":\"Sat Aug 18 21:19:39 GMT 2018\",\"clientIpAddress\":\"172.20.0.4\",\"serverIpAddress\":\"172.20.0.9\"}"}

````


<a name="audit_events"></a>
### TARA Audit trail events

The following is a complete list of TARA specific audit events:

| **Event** | **Description** |
| :---------------- | :---------- |
| `CLIENT_CERT_HANDLING_SUCCESS` | Initial ID-Card certificate header verification was successful. |
| `CLIENT_CERT_HANDLING_FAILURE` | Initial ID-Card certificate header verification has failed. |
| `ESTEID_AUTHENTICATION_SUCCESS` | A successful ID-Card authentication procedure has been completed. |
| `ESTEID_AUTHENTICATION_FAILURE` | ID-Card authentication has failed. |
| `MID_AUTHENTICATION_INIT_SUCCESS` | Estonian Mobile-ID init request successful. |
| `MID_AUTHENTICATION_INIT_FAILURE` | Estonian Mobile-ID init request failed. |
| `MID_AUTHENTICATION_STATUS_POLL_SUCCESS` | Estonian Mobile-ID status check request was successful. |
| `MID_AUTHENTICATION_STATUS_POLL_FAILURE` | Estonian Mobile-ID status check request failed. |
| `EIDAS_AUTHENTICATION_INIT_SUCCESS` | eIDAS authentication was successfully initiated. |
| `EIDAS_AUTHENTICATION_INIT_FAILURE` | eIDAS authentication failed to init. |
| `EIDAS_AUTHENTICATION_CALLBACK_SUCCESS` | eIDAS authentication successful. |
| `EIDAS_AUTHENTICATION_CALLBACK_FAILURE` | eIDAS authentication failed (the other party replied with an error). |
| `BANKLINK_AUTHENTICATION_INIT_SUCCESS` | Banklink authentication request successfully sent. |
| `BANKLINK_AUTHENTICATION_INIT_FAILURE` | Error while creating the banklink request. |
| `BANKLINK_AUTHENTICATION_CALLBACK_SUCCESS` | Bank's response was successfully received and validated. |
| `BANKLINK_AUTHENTICATION_CALLBACK_FAILURE` | Error occurred while processing the bank's response. |

NB! See additional list of CAS related events [here](https://apereo.github.io/cas/5.1.x/installation/Audits.html#audit-events)


**Log verbosity level**

Log verbosity is controlled by the following properties in the default `log4j2.xml` file:

| **Property**       | **Description** | **Default** |
| :---------------- | :---------- | :-----------|
| **cas.log.level** | Controls the detail level of the main event stream (`cas.log`).  | `info` |
| **cas.console.level** | Console log verbosity level | `off` |

These parameters can be overridden when needed:

* By providing the `log4j2.xml` file with new defaults. Note that CAS monitors the `log4j2.xml` file changes and reloads the configuration automatically accordingly.


Example:
````
<?xml version="1.0" encoding="UTF-8" ?>
<Configuration monitorInterval="5" packages="org.apereo.cas.logging">
    <Properties>
        ...
        <Property name="cas.log.level">debug</Property>
        <Property name="cas.console.level">off</Property>
    </Properties>
    ...
````


* By providing the parameter as a system property on service startup.

Example:
````
export JAVA_OPTS="-Dcas.log.level=debug -Dcas.console.level=off"
````


### Interfacing with Tara-Stat

TARA can also send statistics as JSON formatted event stream to the [Tara-Stat service](https://e-gov.github.io/TARA-Stat/Dokumentatsioon).

Note that the Tara-Stat logger is not enabled by default. Tara-Stat needs to be explicitly configured in `application.properties` and `log4j2.xml` file (see [Tara-Stat configuration](Configuration.md#tara_stat) for further details)


<a name="configuration_parameters"></a>
## Configuration parameters
--------------------

The configuration of the TARA service is managed through a central configuration properties file - `application.properties`. In addition to Apereo CAS configuration properties described [here](https://apereo.github.io/cas/5.1.x/installation/Configuration-Properties.html) the `application.properties` can also include properties for TARA specific features. The following document describes the custom configuration properties available in TARA service.


<a name="id_card"></a>
### ID-card authentication

Table 1 - Enabling ID-card authentication feature in TARA

| Property        | Mandatory | Description |
| :---------------- | :---------- | :----------------|
| `id-card.enabled` | N | Feature toggle for authentication with ID-card in TARA. Enables this feature to be loaded if set to `true`, otherwise ignores all other ID-card related configuration. Defaults to `false`, if not specified. |

Table 2 - Enabling ID-card certificate validation

| Property        | Mandatory | Description |
| :---------------- | :---------- | :----------------|
| `id-card.ocsp-enabled` | N | Enables ID-card certificate validation if set to `true`, otherwise ignores all other ocsp related configuration. Defaults to `false`, if not specified. |

Table 3 - Configuring ID-card OCSP 

| Property        | Mandatory | Description |
| :---------------- | :---------- | :----------------|
| `id-card.ocsp-url` | N | HTTP URL of the OCSP service. Defaults to `http://demo.sk.ee/ocsp`, if not specified. |
| `id-card.ocsp-certificate-location` | Y | Path to the location of the trusted CA certificates. In case the certificate files are to be loaded from classpath, this path should be prefixed with `classpath:`. In case the certificate files are to be loaded from disk, this path should be prefixed with `file:`. |
| `id-card.ocsp-certificates` | Y | A comma separated list of trusted CA certificates in the form of `<common_name>:<file_name>`. |

Example:

````
id-card.enabled = true
id-card.ocsp-enabled=true
id-card.ocsp-url=http://demo.sk.ee/ocsp
id-card.ocsp-certificate-location=file:/etc/ocspcerts/test
id-card.ocsp-certificates=TEST of ESTEID-SK 2011:TEST_of_ESTEID-SK_2011.crt,TEST of ESTEID-SK 2015:TEST_of_ESTEID-SK_2015.crt
````


<a name="mobile_id"></a>
### Mobile-ID authentication

Table 4 - Enabling mobile-ID authentication feature in TARA

| Property        | Mandatory | Description |
| :---------------- | :---------- | :----------------|
| `mobile-id.enabled` | N | Feature toggle for authentication with mobile-ID in TARA. Enables this feature to be loaded if set to `true`, otherwise ignores all other mobile-ID related configuration. Defaults to `false`, if not specified. |

Table 5 - Configuring Mobile-ID authentication

| Property        | Mandatory | Description |
| :---------------- | :---------- | :----------------|
| `mobile-id.country-code` | N | Country of origin. ISO 3166-type 2-character country codes are used. Defaults to `EE`, if not specified.<br>For more information, see `CountryCode` query parameter in [DigiDocService Specification](http://sk-eid.github.io/dds-documentation/api/api_docs/#mobileauthenticate). |
| `mobile-id.language` | N | Language for user dialog in mobile phone. 3-letters capitalized acronyms are used. Possible values: <ul><li>`EST`</li><li>`ENG`</li><li>`RUS`</li><li>`LIT`</li></ul> Defaults to `EST`, if not specified.<br>For more information, see `Language` query parameter in [DigiDocService Specification](http://sk-eid.github.io/dds-documentation/api/api_docs/#mobileauthenticate). |
| `mobile-id.service-name` | N | Name of the service – previously agreed with Application Provider and DigiDocService operator. Maximum length – 20 chars. Defaults to `Testimine`, if not specified.<br>For more information, see `ServiceName` query parameter in [DigiDocService Specification](http://sk-eid.github.io/dds-documentation/api/api_docs/#mobileauthenticate). |
| `mobile-id.message-to-display` | N | Text displayed in addition to ServiceName and before asking authentication PIN. Maximum length is 40 bytes. In case of Latin letters, this means also a 40 character long text, but Cyrillic characters may be encoded by two bytes and you will not be able to send more than 20 symbols. Defaults to `''`, if not specified.<br>For more information, see `MessageToDisplay` query parameter in [DigiDocService Specification](http://sk-eid.github.io/dds-documentation/api/api_docs/#mobileauthenticate). |
| `mobile-id.service-url` | N | HTTP URL of the DigiDocService operator. Defaults to `https://tsp.demo.sk.ee`, if not specified. |

Example:

````
mobile-id.enabled=true
mobile-id.country-code=EE
mobile-id.language=EST
mobile-id.service-name=Testimine
mobile-id.message-to-display=Näita siin
mobile-id.service-url=https://tsp.demo.sk.ee
````


<a name="eidas"></a>
### eIDAS authentication

Table 6 - Enabling eIDAS authentication feature in TARA

| Property        | Mandatory | Description |
| :---------------- | :---------- | :----------------|
| `eidas.enabled` | N | Feature toggle for authentication with eIDAS in TARA. Enables this feature to be loaded if set to `true`, otherwise ignores all other eIDAS related configuration. Defaults to `false`, if not specified. |

Table 7 - Configuring eIDAS authentication

| Property        | Mandatory | Description |
| :---------------- | :---------- | :----------------|
| `eidas.service-url` | Y | HTTP base URL of the eIDAS-client microservice. |
| `eidas.heartbeat-url` | N | HTTP URL of the eIDAS-client microservice heartbeat endpoint. Affects TARA [heartbeat endpoint](#heartbeat). |
| `eidas.available-countries` | Y | A comma separated list of ISO 3166-1 alpha-2 country codes that determine which countries are displayed on the login page. |

Example:

````
eidas.enabled=true
eidas.service-url=https://<eidas-client-host:port>
eidas.heartbeat-url=https://<eidas-client-host:port>/heartbeat
eidas.available-countries=EE,LT,LV,FI,NO,IT,IE
````


<a name="banklink"></a>
### Estonian banklinks

Table 8 - Enabling banklink feature in TARA


| Property        | Mandatory | Description |
| :---------------- | :---------- | :----------------|
| `banklinks.enabled` | N | Feature toggle for banklink functionality in TARA. Enables banklinks feature to be loaded when set to `true`, otherwise ignores all other banklink related configuration. Defaults to `false`, if not specified. |

Table 9 - Generic banklink properties

| Property        | Mandatory | Description |
| :---------------- | :---------- | :----------------|
| `banklinks.available-banks` | Y | A comma separated list of bank codes that determine which bank link(s) are displayed on the login page. Supported values in the list are: <ul><li>`seb`</li><li>`luminor`</li><li>`coop`</li><li>`swedbank`</li><li>`lhv`</li><li>`danske`</ul> For example:`seb,lhv,luminor`. <br>Note that adding a bank to this list, requires further bank specific property configuration (see Table 10 for details) |
| `banklinks.keystore` | Y | Path to the keystore that holds bank keys. For example: `classpath:banklinkKeystore.p12`, when the file is to be accessed from the classpath or `file:/etc/cas/banklinkKeystore.p12` when the file is referenced in the local filesystem.  |
| `banklinks.keystore-type` | N | Keystore type. Defaults to `PKCS12` |
| `banklinks.keystore-pass` | Y | Keystore password. |
| `banklinks.return-url` | Y | HTTP URL for accepting the bank authentication response. Must reference the publicly available TARA `/login` url. |

Table 10 - Bank specific properties


| Property        | Mandatory | Description |
| :---------------- | :---------- | :----------------|
| `banklinks.bank.{0}.sender-id` | Y | Sender ID that uniquely identifies the authentication request sender to the bank. The sender ID is described in the specific bank's banklink agreement. |
| `banklinks.bank.{0}.receiver-id` | Y | Receiver ID uniquely identifies the bank who is the recipient of the authentication request. The receiver ID is described in the specific bank's banklink agreement. |
| `banklinks.bank.{0}.url` | Y | An HTTP URL that accepts login requests. Bank login url. |
| `banklinks.bank.{0}.public-key-alias` | N | Public key alias in the keystore. If not defined, `{0}` (the bank's code) is used. |
| `banklinks.bank.{0}.private-key-alias` | N | Private key alias in the keystore. If not defined, `{0}_priv` is used. |
| `banklinks.bank.{0}.private-key-pass` | N | Private key password in the keystore. Defaults to keystore password when not defined. |
| `banklinks.bank.{0}.auth-info-parser-class` | N | A class name that allows overriding the bank response parsing. The class must implement the `AuthLinkInfoParser` interface. By default, a standard parser is used. |
| `banklinks.bank.{0}.try-re-encodes` | N | A comma separated list of standard charset names. When configured with a list of valid character set names, the TARA retries a failing signature validation with re-encoded response (using all the character set's specified). By default, only the character set requested in authentication request is used. |
| `banklinks.bank.{0}.nonce-expires-in-seconds` | N | Specifies the nonce's Time-To-Live in seconds. Defaults to 3600 seconds (1 hour). |

NB! Property placeholder `{0}` refers to a specific bank code (see property description for `banklinks.available-banks`).


Example:

````
banklinks.enabled = true
banklinks.available-banks=coop,lhv
banklinks.keystore=classpath:/banklink/banklinkKeystore-test.p12
banklinks.keystore-type=PKCS12
banklinks.keystore-pass=changeit
banklinks.return-url=https://<frontendhost/context>/cas/login

# COOP
banklinks.bank.coop.sender-id=RIA
banklinks.bank.coop.receiver-id=COOP
banklinks.bank.coop.url=https://www.testcoop.ee/banklinkurl

# LHV
banklinks.bank.lhv.sender-id=RIA
banklinks.bank.lhv.receiver-id=LHV
banklinks.bank.lhv.url=https://www.testlhv.ee/banklinkurl
````


<a name="smart-id"></a>
### Estonian Smart-ID

Table 11 - Enabling Smart-ID authentication feature in TARA

| Property        | Mandatory | Description |
| :---------------- | :---------- | :----------------|
| `smart-id.enabled` | N | Feature toggle for authentication with Smart-ID in TARA. Enables this feature to be loaded if set to `true`, otherwise ignores all other Smart-ID related configuration. Defaults to `false`, if not specified. |

Table 12 - Other Smart-ID configuration properties (if Smart-ID is enabled)

| Property        | Mandatory | Description |
| :---------------- | :---------- | :----------------|
| `smart-id.host-url` | Y | HTTP URL of the Smart-ID service. |
| `smart-id.relying-party-name` | Y | Name of the relying party according to the contract between Smart-ID service provider and the relying party. This field is case insensitive. |
| `smart-id.relying-party-uuid` | Y | UUID value of the relying party according to the contract between Smart-ID service provider and the relying party. |
| `smart-id.authentication-hash-type` | N | Type of the authentication hash that is used to generate the control code of an authentication request. Supported values are: <ul><li>`SHA256`</li><li>`SHA384`</li><li>`SHA512`</li></ul> Defaults to `SHA512`, if not specified. |
| `smart-id.authentication-consent-dialog-display-text` | Y | Description of the authentication request. Displayed on the consent dialog shown on the end user's device. |
| `smart-id.session-status-socket-open-duration` | N | Maximum duration in milliseconds a session status query is kept alive. Defaults to `3000`, if not specified. |
| `smart-id.timeout-between-session-status-queries` | N | Timeout in milliseconds between consecutive session status queries. Defaults to `3000`, if not specified. |
| `smart-id.read-timeout` | N | Maximum total time in milliseconds to be spent on status queries during a session. Defaults to `30000`, if not specified. <br>This value should not be smaller than `smart-id.session-status-socket-open-duration`! |
| `smart-id.connection-timeout` | N | Maximum time spent in milliseconds on waiting for connection with Smart-ID service provider. Defaults to `5000`, if not specified. |
| `smart-id.trusted-ca-certificates-location` | Y | Path to the location of the trusted CA certificates. In case the certificate files are to be loaded from classpath, this path should be prefixed with `classpath:`. In case the certificate files are to be loaded from disk, this path should be prefixed with `file:`. |
| `smart-id.trusted-ca-certificates` | Y | A comma separated list of the names of the files of the trusted CA certificates. These certificates are used to validate the user certificated returned by the Smart-ID service. |

Example:

````
smart-id.enabled=true
smart-id.host-url=https://sid.demo.sk.ee/smart-id-rp/v1/
smart-id.relying-party-name=DEMO
smart-id.relying-party-uuid=00000000-0000-0000-0000-000000000000
smart-id.authentication-hash-type=SHA512
smart-id.authentication-consent-dialog-display-text=TEST
smart-id.session-status-socket-open-duration=3000
smart-id.timeout-between-session-status-queries=3000
smart-id.read-timeout=30000
smart-id.connection-timeout=5000
smart-id.trusted-ca-certificates-location = file:/etc/ocsp
smart-id.trusted-ca-certificates = TEST_1.crt,TEST_1.crt
````

More information about Estonian Smart-ID can be obtained from [here](https://github.com/SK-EID/smart-id-documentation).


<a name="heartbeat"></a>
### Heartbeat endpoint

TARA heartbeat endpoint is a Spring Boot Actuator endpoint and thus is configured as described [here](https://docs.spring.io/spring-boot/docs/1.5.3.RELEASE/reference/html/production-ready-endpoints.html), while also taking into consideration CAS specific configuration properties as described [here](https://apereo.github.io/cas/5.1.x/installation/Configuration-Properties.html#spring-boot-endpoints).

Table 13 - Configuring heartbeat endpoint in TARA

| Property        | Mandatory | Description |
| :---------------- | :---------- | :----------------|
| `endpoints.heartbeat.*` | N | Spring Boot specific actuator configuration. |
| `endpoints.heartbeat.timeout` | N | Maximum time to wait on status requests made to systems that TARA is depending on, in seconds. Defaults to 3 seconds. |

Table 14 - Heartbeat endpoints on systems TARA is depending on

| Property        | Mandatory | Description |
| :---------------- | :---------- | :----------------|
| `eidas.heartbeat-url` | N | HTTP URL of the eIDAS-client microservice heartbeat endpoint. If set, the eIDAS-client status affects the overall reported status of TARA-server. |

Example configuration with **heartbeat** endpoint enabled, accessible without authentication and from all IP-addresses, and configure eIDAS-client **heartbeat** URL:

````
endpoints.heartbeat.enabled=true
endpoints.heartbeat.sensitive=false

# Allow access from all IP-addresses
cas.adminPagesSecurity.ip=.+

# Configure eIDAS-client heartbeat url
eidas.heartbeat-url=https://<eidas-client-host:port>/heartbeat
````


<a name="tara_stat"></a>
### TARA-Stat interfacing

The TARA-Stat service (see https://e-gov.github.io/TARA-Stat/Dokumentatsioon for details) can be used as one of the receivers of TARA statistics.

Table 15 - Enabling TARA-Stat statistics logging

| Property        | Mandatory | Description |
| :---------------- | :---------- | :----------------|
| `statistics.tara-stat.enabled` | N | Feature toggle for logging statistics info to the TARA-Stat service. Enables this feature to be loaded if set to `true`, otherwise disables it. Defaults to `false`, if not specified. |

NB! When enabled, additional logger and appender must be configured to send the statistics to the external service (in `log4j2.xml`).

Example log4j2 configuration for sendind statictics over TCP in syslog format:

````
<?xml version="1.0" encoding="UTF-8"?>
<Configuration status="WARN">
   <Appenders>
      ... additional appenders ...
      <Syslog name="taraStatServiceAppender" host="tara-stat.dev" port="5001" protocol="TCP" charset="UTF-8" newLine="true" facility="AUTH" />
   </Appenders>

   <Loggers>

      ... additional loggers ...
      <AsyncLogger name="ee.ria.sso.statistics.TaraStatHandler" level="info" additivity="false">
         <AppenderRef ref="taraStatServiceAppender"/>
      </AsyncLogger>
   </Loggers>
</Configuration>
````


<a name="test_environment_warning"></a>
### Test environment warning message

Table 16 - Configuring TARA login page to show a warning message about it being run against test services

| Property        | Mandatory | Description |
| :---------------- | :---------- | :----------------|
| `env.test.message` | N | Warning message to show. No warning displayed if not set. |

Example:

````
env.test.message=Tegemist on testkeskkonnaga ja autentimiseks vajalik info on <a href="https://e-gov.github.io/TARA-Doku/Testimine#testimine-testnumbrite-ja-id-kaardiga" class="alert-link">TARA dokumentatsioonis</a>!
````


<a name="audit_logging"></a>
### Audit logging

Table 17 - Relevant CAS parameters for TARA audit log

| Property        | Mandatory | Description |
| :---------------- | :---------- | :----------------|
| `cas.audit.appCode` | N | The tara instance name to be displayed in the audit event. Display's `CAS` by default, if not specified. |

Example:

````
cas.audit.appCode=TARA-INSTANCE-1
````

NB! Note that audit logging can be further customized by CAS configuration parameters (see [CAS documentation](https://apereo.github.io/cas/5.1.x/installation/Configuration-Properties.html#audits)).
